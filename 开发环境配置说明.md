# PiliPala 开发环境配置说明

本文档记录了哔哩哔哩第三方客户端 PiliPala 项目的完整开发环境要求，用于在不同电脑间快速搭建开发环境。

## 必需环境

### Flutter SDK
- **版本要求**: Flutter 3.19.6 (stable channel)
- **Dart版本**: SDK ">=3.0.0 <4.0.0"
- **建议**: 使用 FVM (Flutter Version Management) 管理版本

### Android开发环境
- **Android SDK**: 版本 36.1.0
- **Java**: OpenJDK 21.0.7 (已验证可用)
- **Android Studio**: 2025.1.3
- **最低API级别**: 21 (Android 5.0)
- **目标SDK**: flutter.targetSdkVersion
- **编译SDK**: flutter.compileSdkVersion
- **NDK**: flutter.ndkVersion
- **支持架构**: armeabi-v7a, arm64-v8a

### 系统要求
- **操作系统**: Windows 10/11
- **开发者模式**: 必须启用 (用于符号链接支持)
  - 运行命令: `start ms-settings:developers`
- **Gradle**: 7.5 (项目自带)

## 关键配置文件

### 版本管理
- `.fvm/fvm_config.json`: FVM Flutter版本配置
- `.fvmrc`: FVM版本锁定文件
- `pubspec.yaml`: 依赖包版本定义
- `pubspec.lock`: 依赖包版本锁定

### Android配置
- `android/app/build.gradle`: 应用级构建配置，包含签名和多架构支持
- `android/build.gradle`: 项目级Gradle配置
- `android/gradle.properties`: Gradle属性配置
- `android/settings.gradle`: 模块设置

## 特殊依赖

### Git依赖包
```yaml
# 弹幕组件
ns_danmaku:
  git:
    url: https://github.com/guozhigq/flutter_ns_danmaku.git
    ref: master

# 悬浮窗组件
floating:
  git:
    url: https://github.com/guozhigq/floating.git
    ref: main

# 媒体播放组件
media_kit:
  git:
    url: https://github.com/media-kit/media-kit
    path: media_kit

media_kit_video:
  git:
    url: https://github.com/media-kit/media-kit
    path: media_kit_video

media_kit_libs_video:
  git:
    url: https://github.com/media-kit/media-kit
    path: libs/universal/media_kit_libs_video
```

### 核心插件依赖
- **media_kit**: 视频播放核心
- **webview_flutter**: 网页视图支持
- **permission_handler**: 权限管理
- **audio_service**: 音频后台服务
- **dio**: 网络请求
- **hive**: 本地数据存储
- **cached_network_image**: 图片缓存
- **get**: 状态管理
- **flutter_smart_dialog**: 对话框组件

## 环境搭建步骤

### 1. Flutter环境
```bash
# 安装FVM (推荐)
dart pub global activate fvm

# 使用项目指定的Flutter版本
fvm use 3.19.6

# 验证环境
fvm flutter doctor
```

### 2. Android环境
```bash
# 验证Android工具链
flutter doctor --android-licenses

# 检查环境状态
flutter doctor -v
```

### 3. 项目初始化
```bash
# 获取依赖
flutter pub get

# 代码生成 (如果需要)
flutter packages pub run build_runner build
```

### 4. 签名配置
创建 `android/key.properties` 文件:
```properties
storeFile=your_keystore.jks
storePassword=your_store_password
keyAlias=your_key_alias
keyPassword=your_key_password
```

或设置环境变量:
```bash
set KEYSTORE=path_to_keystore
set KEYSTORE_PASSWORD=your_password
set KEY_ALIAS=your_alias
set KEY_PASSWORD=your_key_password
```

## IDE配置

### VS Code (推荐)
- 版本: 1.104.2+
- 必需插件:
  - Flutter
  - Dart
  - Flutter Widget Snippets (可选)

### Android Studio
- 版本: 2025.1.3+
- 必需插件:
  - Flutter plugin
  - Dart plugin

## 网络配置

### Pub镜像源
项目使用 `pub.flutter-io.cn` 镜像源，确保网络可访问。

### Git仓库访问
确保能正常访问GitHub，用于下载git依赖包：
- github.com/guozhigq/flutter_ns_danmaku.git
- github.com/guozhigq/floating.git
- github.com/media-kit/media-kit

## 构建命令

### 清理缓存
```bash
# Flutter清理
flutter clean

# Android Gradle清理
cd android && ./gradlew clean && cd ..
```

### 构建APK
```bash
# Release版本
flutter build apk --release

# Debug版本
flutter build apk --debug

# 详细输出
flutter build apk --release --verbose
```

### 构建产物位置
- APK文件: `build/app/outputs/flutter-apk/app-release.apk`
- 文件大小: 约38.4 MB
- SHA1校验: `build/app/outputs/flutter-apk/app-release.apk.sha1`

## 代码质量检查

### 代码分析
```bash
# 静态分析
flutter analyze --no-pub

# 格式化代码
flutter format .

# 运行测试
flutter test
```

### 已知问题
- 113个代码风格建议（不影响构建）
- 主要问题：未使用的变量、import、print语句等
- 180个包有更新版本但受依赖约束限制

## 项目信息

### 应用详情
- **应用名**: pilipala
- **包名**: com.guozhigq.pilipala
- **版本**: 1.0.25+1025
- **最低Android版本**: 5.0 (API 21)
- **目标架构**: armeabi-v7a, arm64-v8a

### 功能特性
- 哔哩哔哩视频播放
- 弹幕支持
- 音频后台播放
- 图片缓存
- 网络代理支持
- 悬浮窗播放
- 投屏功能

## 故障排除

### 常见问题
1. **符号链接错误**: 启用Windows开发者模式
2. **网络超时**: 检查镜像源配置和网络连接
3. **签名失败**: 验证密钥库配置
4. **构建缓存问题**: 执行清理命令后重新构建

### 环境验证
```bash
# 检查Flutter环境
flutter doctor -v

# 检查设备连接
flutter devices

# 验证项目配置
flutter analyze
```

## 版本更新

当需要更新依赖时：
```bash
# 检查过期包
flutter pub outdated

# 更新依赖 (谨慎操作，可能破坏兼容性)
flutter pub upgrade --major-versions
```

---

**注意**: 由于项目使用了特定版本的依赖包，建议严格按照此文档配置环境，避免版本冲突导致的构建失败。